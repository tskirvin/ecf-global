#!/bin/bash
# ssi_yumcache_status - confirm that the daily 'yum check-update' script is
# actually running, based on a status file that just reports on the exit code
# of that command (generated by /usr/libexec/ecf-global/yum-cache-update).

##############################################################################
### Configuration ############################################################
##############################################################################

NAME=`basename $0`
CONFIG=/etc/ecf-global/yum-cache.yaml
MAX_AGE="48 hours ago"

if [ ! -r $CONFIG ] ;then
    echo "cannot read $CONFIG, aborting"
    exit -1
fi

CACHEDIR=`cat $CONFIG | shyaml get-value cachedir`

##############################################################################
### main () ##################################################################
##############################################################################

STATUS=$CACHEDIR/yum-cache.status
if [[ ! -r $STATUS ]]; then
    echo "3 $NAME - cannot read $STATUS (does not exist?)"
    exit -1
fi

if [[ $(date +%s -r $STATUS) -lt $(date +%s --date="$MAX_AGE") ]]; then
    AGE=`date -d "1970-01-01 + $(stat -c %Y $STATUS) secs" --rfc-3339=seconds`
    echo "1 $NAME - $STATUS has not been updated since $AGE"
    exit 1
fi

CONTENT=`cat $STATUS`
case "$CONTENT" in
    '0')
        echo "0 $NAME - no updates found"
        exit 0
        ;;
    '1')
        echo "1 $NAME - yum check-update failed"
        exit 1
        ;;
    '100')
        echo "0 $NAME - updates found"
        exit 0
        ;;
    *)
        echo "3 $NAME - unknown return code from 'yum check-update': $CONTENT"
        exit -1
        ;;
esac

echo "3 $NAME - should never have reached this part of the script"
exit -1
