#!/bin/bash -e

CONFIG=/etc/ecf-global/yum-cache.yaml

if [ ! -r $CONFIG ] ;then
    echo "cannot read $CONFIG, aborting"
    exit -1
fi

OUTDIR=`cat $CONFIG | shyaml get-value cachedir`

DAYS_BASE=`/opt/puppetlabs/bin/facter ssi_kernel_variance`
: ${DAYS_BASE:=60}

DAYS_EXTRA=`cat $CONFIG | shyaml get-value days_extra`
: ${DAYS_EXTRA:=14}

DAYS_WARN=$(($DAYS_BASE))
DAYS_CRIT=$(($DAYS_BASE + $DAYS_EXTRA))

NOW=`date +%s`

for i in `cat $OUTDIR/security.log`; do
    PKG=`echo $i | cut -d \| -f 1`
    FIRST_DATE=`echo $i | cut -d \| -f 2`
    timestamp=`date -d $FIRST_DATE +%s`
    AGE=$(( ($NOW - $timestamp) / 86400 ))
    if   [[ $AGE -gt $DAYS_CRIT ]]; then
        STATUS='CRIT'
        EXIT=2
    elif [[  $AGE -gt $DAYS_WARN ]]; then
        STATUS='WARN'
        if [[ $EXIT < 2 ]]; then EXIT=1; fi
    else
        STATUS='OK'
    fi
    printf "%4s  %4.0f days old  %s\n" $STATUS $AGE $PKG
done

exit $EXIT

###############################################################################
### Documentation #############################################################
###############################################################################

# Documentation.  Use a hack to hide this from the shell.  Because of the
# above exit line, this should never be executed.
DOCS=<<__END_OF_DOCS__

=head1 NAME

yumcache-security - list security-related packages that need to be updated

=head1 SYNOPSIS

B<yumcache-security>

=head1 DESCRIPTION

yumcache-security parses F</var/cache/ecf-global/security.log> (a database of
packages to be updated that are security-related), and prints a list of
packages and days-since-we-heard-about-the-package to STDOUT.  This list
includes:

=over 4

=item status (OK/WARN/CRIT) 

Have we exited our "update window"?  This is (generally) 60 days (pulled from
the I<ssi_kernel_variance> fact) plus 14 days grace (from the config file).

=item days old 

=item package name

=back

The exit code is 0 (no packages in WARN/CRIT), 1 (no packages in CRIT, but some
in WARN), or 2 (some packages in CRIT).

=head1 PARAMETERS

=over 4

=item F</etc/ecf-global/yum-cache.yaml>

Shared configuration for the B<yumcache> suite.

=item F</var/cache/ecf-global/security.log>

Generated by B</usr/libexec/ecf-global/yumcache-build-from-cache>, contains a
list of packages that need to be updated sooner-or-later along with the date at
which they first appeared.

=back

=head1 SEE ALSO

B<yumcache-all>

B</usr/libexec/ecf-global/*>

=head1 AUTHOR

Tim Skirvin <tskirvin@fnal.gov>

=head1 LICENSE

Copyright 2016, Fermi National Accelerator Laboratory

This program is free software; you may redistribute it and/or modify
it under the same terms as Perl itself.

=cut

__END_OF_DOCS__

